<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Key Validator</title>
</head>
<body>
    <pre id="status">INVALID</pre>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDCZrt54NfMZkTzpsX-ZJBhA2Qh9a4ATQU",
          authDomain: "keycodm-add11.firebaseapp.com",
          databaseURL: "https://keycodm-add11-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "keycodm-add11",
          storageBucket: "keycodm-add11.appspot.com",
          messagingSenderId: "203989625230",
          appId: "1:203989625230:web:7fd9631e5fa9d02e76dcdf",
          measurementId: "G-6PDW8Z787R"
        };

        async function validate() {
            const statusElement = document.getElementById('status');
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);

                const urlParams = new URLSearchParams(window.location.search);
                const userKey = urlParams.get('key');

                if (!userKey) {
                    statusElement.textContent = 'INVALID_NO_KEY';
                    return;
                }

                // ===================================================================
                // === LOGIKA BARU YANG LEBIH AKURAT ===
                //
                // Query ini meminta Firebase untuk:
                // 1. Mencari dokumen yang field 'key'-nya sama dengan 'userKey'.
                // 2. DAN (ini yang penting) yang field 'expiry'-nya LEBIH BESAR DARI
                //    waktu server SAAT INI (Timestamp.now()).
                //
                // Jika ada dokumen yang cocok, berarti key itu ada DAN belum kedaluwarsa.
                // Semua perbandingan waktu terjadi di server, jadi tidak ada masalah timezone.
                // ===================================================================
                const keysRef = collection(db, "premiumKeys");
                const q = query(
                    keysRef, 
                    where("key", "==", userKey), 
                    where("expiry", ">", Timestamp.now())
                );
                
                const querySnapshot = await getDocs(q);

                // Jika querySnapshot menemukan setidaknya satu dokumen, berarti key itu VALID.
                if (!querySnapshot.empty) {
                    statusElement.textContent = 'VALID';
                } else {
                    // Jika tidak ada yang cocok, berarti key tidak ada atau sudah kedaluwarsa.
                    statusElement.textContent = 'INVALID';
                }

            } catch (error) {
                console.error("Validation Error:", error);
                statusElement.textContent = 'ERROR';
            }
        }

        validate();
    </script>
</body>
</html>

